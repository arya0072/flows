id: generic_transform_dbt_build
namespace: dev

inputs:
  - id: dbt_models
    type: STRING
    required: true

  - id: environment
    type: SELECT
    values:
      - dev
      - prod
    required: true

tasks:
  - id: dbt_build
    type: io.kestra.plugin.dbt.cli.DbtCLI
    namespaceFiles:
      enabled: true
    containerImage: ghcr.io/kestra-io/dbt-bigquery:latest
    projectDir: dbt
    commands:
      - "dbt build --project-dir dbt --select +mart.{{ inputs.dbt_models }} --show-all-deprecations"
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
    profiles: |
      mp_dbt:
        outputs:
          dev:
            dataset: mp_staging
            job_execution_timeout_seconds: 300
            job_retries: 1
            keyfile_json: {{ secret('GCP_SERVICE_ACCOUNT') }}
            location: US
            method: service-account-json
            priority: interactive
            project: mitraprodin-data-warehouse
            threads: 4
            type: bigquery
          prod:
            dataset: mp_dbt
            job_execution_timeout_seconds: 300
            job_retries: 1
            keyfile_json: {{ secret('GCP_SERVICE_ACCOUNT') }}
            location: US
            method: service-account-json
            priority: interactive
            project: mitraprodin-data-warehouse
            threads: 4
            type: bigquery
        target: {{ inputs.environment }}